<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Checkout</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0f172a;color:#e5e7eb}
    .wrap{max-width:720px;margin:0 auto;padding:20px}
    .card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:16px}
    label{display:block;margin:10px 0 6px}
    input{width:100%;padding:12px;border-radius:10px;border:1px solid #263245;background:#0b1220;color:#e5e7eb}
    button{margin-top:12px;background:#1d4ed8;color:#fff;border:0;padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer;width:100%}
    .muted{color:#94a3b8}
    .error{background:#450a0a;border:1px solid #7f1d1d;padding:10px;border-radius:10px;color:#fecaca;margin-bottom:10px;display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Checkout</h1>
    <p id="summary" class="muted"></p>
    <div id="err" class="error"></div>

    <!-- Hidden iframe: lets us POST to ConvertKit without leaving the page -->
    <iframe name="ck_bg" style="display:none;"></iframe>

    <!-- Direct POST to ConvertKit (background target) -->
    <form id="ck" class="card" action="https://app.convertkit.com/forms/8478389/subscriptions" method="post" target="ck_bg">
      <!-- visible fields only -->
      <label>Full name *</label>
      <input name="first_name" type="text" required placeholder="Full name"/>

      <label>Email *</label>
      <input name="email_address" id="email_address" type="email" required placeholder="you@example.com"/>

      <label>Phone *</label>
      <input name="fields[phone]" id="phone" type="tel" required placeholder="+1 555 123 4567"/>

      <label>City *</label>
      <input name="fields[city]" id="city" type="text" required placeholder="City"/>

      <!-- hidden (auto-filled) -->
      <input type="hidden" name="fields[product_id]" id="product_id">
      <input type="hidden" name="fields[product]"    id="product">
      <input type="hidden" name="fields[price]"      id="price">

      <button type="submit">Confirm</button>
      <p class="muted" style="margin-top:8px">You’ll receive a thank-you email automatically.</p>
    </form>
  </div>

  <script>
    // === 1) Product summary (unchanged) ===
    const PRODUCTS = {
      "HP-001": { name:"Wireless Pro Headphones", price:"49.00" },
      "SP-002": { name:"Smartwatch Plus",         price:"79.00" },
      "BK-003": { name:"Power Bank 20k",          price:"29.00" }
    };

    const q = new URLSearchParams(location.search);
    const pid = q.get('pid');
    const sel = pid && PRODUCTS[pid];

    const errEl = document.getElementById('err');
    const btn   = document.querySelector('#ck button[type="submit"]');

    if (!sel) {
      errEl.textContent = 'Invalid product link. Please go back and choose a product.';
      errEl.style.display = 'block';
      if (btn) btn.disabled = true;
      document.getElementById('summary').textContent = '';
    } else {
      document.getElementById('summary').textContent =
        `You're buying: ${sel.name} (ID: ${pid}) — $${sel.price}`;
      document.getElementById('product_id').value = pid;
      document.getElementById('product').value    = sel.name;
      document.getElementById('price').value      = sel.price;
    }

    // === 2) After ConvertKit submit → redirect to Stripe ===
    // Replace with your Stripe Payment Link (test link now; live later)
    const STRIPE_LINK = "https://buy.stripe.com/test_14A4gy7oa7d0cai8KI08g00";

    const formEl  = document.getElementById('ck');
    const emailEl = document.getElementById('email_address');

    if (formEl) {
      formEl.addEventListener('submit', function () {
        // Save a copy locally (handy if you want to read it on another page)
        const name  = (formEl.querySelector('input[name="first_name"]')?.value || '').trim();
        const email = (emailEl?.value || '').trim();
        const phone = (document.getElementById('phone')?.value || '').trim();
        const city  = (document.getElementById('city')?.value || '').trim();

        try {
          localStorage.setItem('ck_email', email);
          localStorage.setItem('ck_name', name);
          localStorage.setItem('ck_phone', phone);
          localStorage.setItem('ck_city', city);
          localStorage.setItem('ck_product_id', pid || '');
          localStorage.setItem('ck_product_name', sel ? sel.name : '');
          localStorage.setItem('ck_price', sel ? sel.price : '');
        } catch (_) {}

        // Build Stripe URL (prefill email + a reference we can trace)
        const ref = [pid || 'NA', Date.now()].join('-');
        const stripeUrl = STRIPE_LINK
          + (email ? ("?prefilled_email=" + encodeURIComponent(email)) : "")
          + (email ? ("&") : "?")
          + "client_reference_id=" + encodeURIComponent(ref);

        // Give the browser a moment to POST to ConvertKit in the hidden iframe,
        // then move the main window to Stripe Checkout.
        setTimeout(() => { window.location.href = stripeUrl; }, 600);
        // Note: we do NOT preventDefault; the form still posts to ConvertKit (in iframe).
      });
    }
  </script>
</body>
</html>
